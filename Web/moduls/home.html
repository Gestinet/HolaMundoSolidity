<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
        <head>
                <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
                <title>GESTITOKEN SUPREMO</title>
                <link rel="stylesheet" type="text/css" href="css/index.css">
                <script src="moduls/node_modules/web3/dist/web3.min.js"></script>
        </head>
        <body>
                <h1>Comprar GestiToken</h1>        
                
                <label for="compteC" class="col-lg-2 control-label">ID Compte</label>
                <input id="compteC" type="text">
                <label for="quantitatC" class="col-lg-2 control-label">Ethers per poder comprar</label>
                <input id="quantitatC" type="number">
                <button id="comprar">Comprar</button>                

                <marquee>Hello world!</marquee>
                <h1>Vendre GestiToken</h1>
                <form>
                        ID Compte
                        <input type="text" name="comptev"><br>
                        Quantitat a vendre
                        <input type="text" name="quantitat"><br>                        
                        <input type="submit" value="Vendre"/>
                </form>
                <marquee>Hello world!</marquee>
                <p class="und">Gracias por contratar nuestros servicios.</p>
                <p>0xD2e6aC3d4CF244A7B9B975dad750112b483AB862</p>
                <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>

                <script>
                        var Web3 = require('web3');                                                                      
                        var coder = require('moduls/node_modules/web3/lib/solidity/coder');
                        var CryptoJS = require('crypto-js');
                        var privateKey = new Buffer("Cyka Blyat", 'hex');

                        //Creem sessió amb la API Ropsten Infura
                        if (typeof web3 !== 'undefined') {                                
                                web3 = new Web3(web3.currentProvider);
                                console.log("Primer");
                        } else {
                                // If no injected web3 instance is detected, fallback to the TestRPC.                                                                
                                var web3 = new Web3(new Web3.providers.HttpProvider("https://ropsten.infura.io/IoZZfPaoqy65LGBcUygs"));  
                                console.log("Segon");
                        } 



                        //Inicialitzem contracte
                        var GestiContracte = web3.eth.contract([{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"tokens","type":"uint256"}],"name":"approve","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"startDate","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"from","type":"address"},{"name":"to","type":"address"},{"name":"tokens","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"_totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"bonusEnds","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"tokenOwner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"acceptOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"to","type":"address"},{"name":"tokens","type":"uint256"}],"name":"transfer","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"endDate","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"tokens","type":"uint256"},{"name":"data","type":"bytes"}],"name":"approveAndCall","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"newOwner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"tokenAddress","type":"address"},{"name":"tokens","type":"uint256"}],"name":"transferAnyERC20Token","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"tokenOwner","type":"address"},{"name":"spender","type":"address"}],"name":"allowance","outputs":[{"name":"remaining","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_from","type":"address"},{"indexed":true,"name":"_to","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"tokens","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"tokenOwner","type":"address"},{"indexed":true,"name":"spender","type":"address"},{"indexed":false,"name":"tokens","type":"uint256"}],"name":"Approval","type":"event"}],'0x4cc89dc9faf58b4d5f9a4eba0934039bafe1e90a');
                        console.log("Tercer");                        

                        var gestiContracteInstancia = GestiContracte.at('0x4cc89dc9faf58b4d5f9a4eba0934039bafe1e90a');
                        gestiContracteInstancia._eth.defaultAccount="0x4cc89dc9faf58b4d5f9a4eba0934039bafe1e90a";
                        console.log("Quart");

                        $("#comprar").click(function() {
                                
                                //var gestiContracteInstancia = GestiContracte.at('0x4cc89dc9faf58b4d5f9a4eba0934039bafe1e90a');
                                //gestiContracteInstancia.options.address = $("#compteC").val();
                                //var privateKeyRaw = web3.sha3("Cyka Blyat");                                

                                //gestiContracteInstancia.transfer($("#compteC").val(),$("#quantitatC").val());
                                //console.log("Cinqué");

                                var functionName = 'addRecord'  
                                var types = ['uint','bytes32','bytes20','bytes5','bytes']  
                                var args = [1, 'fjdnjsnkjnsd', '03:00:21 12-12-12', 'true', '']  
                                var fullName = functionName + '(' + types.join() + ')'  
                                var signature = CryptoJS.SHA3(fullName,{outputLength:256}).toString(CryptoJS.enc.Hex).slice(0, 8)  
                                var dataHex = signature + coder.encodeParams(types, args)  
                                var data = '0x'+dataHex  

                                var account = $("#compteC").val();
                                var nonce = web3.toHex(web3.eth.getTransactionCount(''))  
                                var gasPrice = web3.toHex(web3.eth.gasPrice)  
                                var gasLimitHex = web3.toHex(300000);
                                var rawTx = { 'nonce': nonce, 'gasPrice': gasPrice, 'gasLimit': gasLimitHex, 'from': account, 'to': '0x4cc89dc9faf58b4d5f9a4eba0934039bafe1e90a', 'data': data}  
                                var tx = new Tx(rawTx);
                                tx.sign(privateKey);
                                var serializedTx = '0x'+tx.serialize().toString('hex');
                                web3.eth.sendRawTransaction(serializedTx, function(err, txHash){ console.log(err, txHash) });

                        });
                                  
                </script>
        </body>
</html>
